---

- name: Package is available
  copy:
    src: grafana_4.4.1_amd64.deb
    dest: /root/grafana_4.4.1_amd64.deb

- name: Package is installed
  apt:
    deb: /root/grafana_4.4.1_amd64.deb
    state: present

- name: Configuration is installed
  template:
    src: grafana.ini
    dest: /etc/grafana/grafana.ini
  notify: Reset Grafana

- name: Directories for tasks exist
  file:
    path: "{{item}}"
    state: directory
    mode: 0700
  with_items:
  - /root/grafana-tasks
  - /root/grafana-tasks/requests
  - /root/grafana-tasks/status

- name: Tasks requests are available
  template:
    src: requests/{{item}}.json
    dest: /root/grafana-tasks/requests/{{item}}.json
    mode: 0600
  with_items:
  - datasource
  - dashboard-host
  - user-organisation
  - user-account
  - user-role
  notify: Reset Grafana

- meta: flush_handlers

- name: Service is started and enabled
  service:
    name: grafana-server
    state: started
    enabled: yes

- name: Grafana is up
  wait_for:
    port: 3000

- name: Datasource, dashboards, and users are configured
  shell: >
    curl
    -X {{item.method}} http://localhost:3000/{{item.endpoint}}
    --user '{{grafana_admin_user}}:{{grafana_admin_password}}'
    --header 'Content-Type: application/json'
    --data-binary @/root/grafana-tasks/requests/{{item.name}}.json
    --fail && touch /root/grafana-tasks/status/{{item.name}}.done
  args:
    creates: /root/grafana-tasks/status/{{item.name}}.done
  with_items:
  - { name: datasource,        endpoint: api/datasources,    method: POST  }
  - { name: dashboard-host,    endpoint: api/dashboards/db,  method: POST  }
  - { name: user-organisation, endpoint: api/orgs/1,         method: PUT   }
  - { name: user-account,      endpoint: api/admin/users,    method: POST  }
  - { name: user-role,         endpoint: api/orgs/1/users/2, method: PATCH }
